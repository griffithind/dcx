# Features Implementation Design

## Overview

Devcontainer Features are self-contained units of installation code and configuration that add tools, languages, and capabilities to development containers.

## Feature Reference Types

### OCI Features

OCI features are stored in container registries following the OCI artifact spec.

Format: `[registry/]repository/feature[:version]`

Examples:
- `ghcr.io/devcontainers/features/go:1`
- `devcontainers/features/node:18` (defaults to ghcr.io)

Resolution:
1. Fetch manifest from registry
2. Extract feature layer (tar.gz)
3. Cache locally by digest

### Local Features

Local features are stored in directories relative to devcontainer.json.

Format: `./path/to/feature` or `../shared/feature`

Resolution:
1. Resolve path relative to config directory
2. Read devcontainer-feature.json
3. Use directly (no caching needed)

### HTTP Features

HTTP features are tarballs available via HTTP(S).

Format: `https://example.com/feature.tar.gz`

Resolution:
1. Download tarball
2. Extract to cache directory
3. Read devcontainer-feature.json

## Feature Structure

Each feature must contain:

```
feature/
├── devcontainer-feature.json   # Metadata and options
├── install.sh                  # Installation script
└── (other files)               # Additional resources
```

### devcontainer-feature.json

```json
{
    "id": "my-feature",
    "version": "1.0.0",
    "name": "My Feature",
    "description": "Description of the feature",
    "options": {
        "version": {
            "type": "string",
            "default": "latest",
            "description": "Version to install"
        }
    },
    "installsAfter": ["ghcr.io/devcontainers/features/common-utils"],
    "dependsOn": [],
    "containerEnv": {
        "MY_FEATURE_HOME": "/opt/my-feature"
    },
    "capAdd": [],
    "securityOpt": [],
    "privileged": false,
    "mounts": []
}
```

## Caching Strategy

Features are cached in: `~/.cache/dcx/features/<cache-key>/`

Cache key computation:
- OCI: SHA256 of canonical reference
- HTTP: SHA256 of URL
- Local: No caching (used directly)

Cache layout:
```
~/.cache/dcx/features/
├── a1b2c3d4e5f6g7h8/          # Cache key
│   ├── devcontainer-feature.json
│   ├── install.sh
│   └── ...
└── ...
```

## Dependency Resolution

### Dependency Types

1. **Hard Dependencies (`dependsOn`)**: Must be installed before this feature
2. **Soft Dependencies (`installsAfter`)**: Prefer to install after these features

### Ordering Algorithm

1. Parse all features and their dependencies
2. Validate all hard dependencies are present
3. Build dependency graph
4. Topological sort with soft dependency preferences
5. Apply `overrideFeatureInstallOrder` if specified

### Cycle Detection

Uses Kahn's algorithm for topological sort. If all nodes cannot be processed, a cycle exists.

## Dockerfile Generation

Features are installed via a generated Dockerfile:

```dockerfile
# Generated by dcx
FROM base-image:tag

ENV DEBIAN_FRONTEND=noninteractive
ENV _REMOTE_USER=root
ENV _REMOTE_USER_HOME=/root

# Feature 1: Go
COPY feature_0 /tmp/dcx-features/feature_0
ENV VERSION=1.21
RUN chmod +x /tmp/dcx-features/feature_0/install.sh && \
    cd /tmp/dcx-features/feature_0 && \
    ./install.sh && \
    rm -rf /tmp/dcx-features/feature_0

# Feature 2: Git
COPY feature_1 /tmp/dcx-features/feature_1
RUN chmod +x /tmp/dcx-features/feature_1/install.sh && \
    cd /tmp/dcx-features/feature_1 && \
    ./install.sh && \
    rm -rf /tmp/dcx-features/feature_1

# Container environment from features
ENV GOPATH=/go
ENV PATH=/go/bin:$PATH

ENV DEBIAN_FRONTEND=dialog
```

## Build Process

1. Resolve base image (from `image` or `build`)
2. Resolve all features
3. Order features by dependencies
4. Generate Dockerfile
5. Create build context with feature directories
6. Build derived image: `dcx/<env_key>:<hash>-features`

## Option Handling

Feature options are passed as environment variables:
- Option name is uppercased
- Value is converted to string
- Defaults are applied for unspecified options

Example:
```json
"features": {
    "ghcr.io/devcontainers/features/go:1": {
        "version": "1.21",
        "gopath": "/custom/go"
    }
}
```

Results in:
```
ENV VERSION=1.21
ENV GOPATH=/custom/go
```

## Security Considerations

1. Feature scripts run as root during build
2. Capabilities and security options are collected from features
3. Privileged mode is propagated if any feature requires it
4. Mounts from features are added to container

## Compose Plan Support

For compose-based configurations:
1. Parse compose file to determine base image of primary service
2. Build derived image with features
3. Override service image in compose override file
4. Use `--no-build` flag with compose to prevent rebuilding

## Error Handling

- Missing hard dependency: Fail immediately with clear error
- Feature resolution failure: Log and fail
- Build failure: Preserve build context for debugging (with --verbose)
- Circular dependencies: Detected during ordering
